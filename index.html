<script>
    const channelNames = [
        "Channel1", "Channel2", "Channel3", "Channel4", "Channel5", "Channel6", "Channel7", "Channel8", "Channel9", "Channel10",
        "Channel11", "Channel12", "Channel13", "Channel14", "Channel15", "Channel16", "Channel17", "Channel18", "Channel19", "Channel20",
        "Channel21", "Channel22", "Channel23", "Channel24", "Channel25"
    ];
    const timerData = {}; // Store the timer states for each button

    function saveTimersToLocalStorage() {
        console.log("Speichere Timer-Daten:", timerData); // Debugging-Ausgabe
        localStorage.setItem('timerData', JSON.stringify(timerData));
    }

    function loadTimersFromLocalStorage() {
        const data = localStorage.getItem('timerData');
        console.log("Lade gespeicherte Timer-Daten:", data); // Debugging-Ausgabe
        return data ? JSON.parse(data) : {};
    }

    function toggleTimer(id) {
        const button = document.getElementById("btn" + id);
        let state = timerData[id];

        if (!state || state.color === "yellow") {
            resetTimer(id, button);
        } else {
            startTimer(id, button);
        }

        // Save the updated state
        saveTimersToLocalStorage();
    }

    function startTimer(id, button) {
        let timeLeft = timerData[id]?.timeLeft || 14400; // Timer starts at 240 minutes (14400 seconds)
        let lastUpdateTime = Date.now();

        button.style.backgroundColor = "green";
        button.innerHTML = formatTime(timeLeft);
        timerData[id] = { color: "green", timeLeft: timeLeft };

        function updateTimer() {
            let now = Date.now();
            let deltaTime = (now - lastUpdateTime) / 1000; // Elapsed time in seconds
            lastUpdateTime = now;

            timeLeft -= deltaTime;
            timerData[id].timeLeft = timeLeft;

            if (timeLeft <= 0) {
                timeLeft = 0;
                button.style.backgroundColor = "yellow";
                button.innerHTML = "0:00";
                timerData[id].color = "yellow"; // Mark timer as yellow
            } else {
                button.innerHTML = formatTime(timeLeft);
            }

            saveTimersToLocalStorage(); // Save the updated state periodically

            if (timerData[id].color !== "yellow") {
                requestAnimationFrame(updateTimer);
            }
        }

        updateTimer();
    }

    function resetTimer(id, button) {
        let timeLeft = 14400; // Reset to 240 minutes
        button.style.backgroundColor = "white";  // Reset color to white
        button.innerHTML = "240:00";  // Reset display to 240:00
        timerData[id] = { color: "white", timeLeft: timeLeft };
        saveTimersToLocalStorage(); // Save the updated state
    }

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${minutes}:${sec < 10 ? "0" + sec : sec}`;
    }

    window.onload = function() {
        const table = document.querySelector("table");
        console.log("Lade Tabelle..."); // Debugging-Ausgabe

        // Dynamische Zeilen hinzufÃ¼gen
        for (let i = 0; i < channelNames.length; i++) {
            const row = document.createElement("tr");
            const channelCell = document.createElement("td");
            channelCell.className = "header";
            channelCell.textContent = channelNames[i];
            row.appendChild(channelCell);

            for (let j = 1; j <= 16; j++) {
                const buttonCell = document.createElement("td");
                const button = document.createElement("button");
                button.id = `btn${i * 16 + j}`; // Unique ID for each button
                button.textContent = "240:00";
                button.onclick = function() {
                    toggleTimer(i * 16 + j);
                };
                buttonCell.appendChild(button);
                row.appendChild(buttonCell);
            }

            table.appendChild(row);
        }

        // Lade gespeicherte Timer-Daten
        const savedTimers = loadTimersFromLocalStorage();
        console.log("Gespeicherte Timer-Daten:", savedTimers); // Debugging-Ausgabe

        // Timer wiederherstellen
        Object.keys(savedTimers).forEach(id => {
            const button = document.getElementById("btn" + id);
            if (button) {
                const state = savedTimers[id];
                timerData[id] = state;

                button.style.backgroundColor = state.color;
                button.innerHTML = formatTime(state.timeLeft);

                if (state.color === "green" && state.timeLeft > 0) {
                    startTimer(id, button); // Restart the timer if it's still running
                }
            }
        });
    };
</script>
