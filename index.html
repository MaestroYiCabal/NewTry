<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Grid</title>
    <style>
        table {
            border-collapse: collapse;
            margin-top: 20px;
        }

        td {
            padding: 5px;
            text-align: center;
        }

        button {
            width: 60px;
            height: 30px;
            font-size: 10px;
            margin: 2px;
            background-color: white;
        }

        .timerDisplay {
            font-size: 10px;
        }

        .header {
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <table>
        <tr>
            <td class="header"></td>
            <td class="header">Channel1</td>
            <td class="header">Channel2</td>
            <td class="header">Channel3</td>
            <td class="header">Channel4</td>
            <td class="header">Channel5</td>
            <td class="header">Channel6</td>
            <td class="header">Channel7</td>
            <td class="header">Channel8</td>
            <td class="header">Channel9</td>
            <td class="header">Channel10</td>
            <td class="header">Channel11</td>
            <td class="header">Channel12</td>
            <td class="header">Channel13</td>
            <td class="header">Channel14</td>
            <td class="header">Channel15</td>
            <td class="header">Channel16</td>
        </tr>
    </table>

    <script>
        const timerData = JSON.parse(localStorage.getItem('timerData')) || {}; // Lade gespeicherte Timer-Daten oder initialisiere als leer
        let timerIntervals = {}; // Objekt, um die Timer-Intervalle zu speichern

        function toggleTimer(id) {
            const button = document.getElementById("btn" + id);
            let state = timerData[id];

            // Wenn der Timer läuft (grün), setze ihn zurück
            if (state && state.color === "green") {
                resetTimer(id, button); // Timer zurücksetzen
            } else {
                startTimer(id, button); // Timer starten
            }
        }

        function startTimer(id, button) {
            let timeLeft = 14400; // Standardzeit 240 Minuten

            // Timer-Daten für diesen Button speichern
            button.style.backgroundColor = "green";
            button.innerHTML = formatTime(timeLeft);
            timerData[id] = { color: "green", timeLeft: timeLeft, lastUpdateTime: Date.now() };

            // Wenn der Timer vorher schon lief, stoppe ihn
            if (timerIntervals[id]) {
                clearInterval(timerIntervals[id]);
            }

            // Update-Funktion für den Timer
            function updateTimer() {
                let now = Date.now();
                let deltaTime = (now - timerData[id].lastUpdateTime) / 1000; // Berechne die verstrichene Zeit in Sekunden
                timerData[id].lastUpdateTime = now;

                timeLeft -= deltaTime;
                timerData[id].timeLeft = timeLeft;

                if (timeLeft <= 0) {
                    timeLeft = 0;
                    button.style.backgroundColor = "yellow";
                    button.innerHTML = "0:00";
                    timerData[id].color = "yellow";
                } else {
                    button.innerHTML = formatTime(timeLeft);
                }

                // Wenn der Timer noch nicht abgelaufen ist, fortfahren
                if (timerData[id].color === "green") {
                    timerIntervals[id] = setInterval(updateTimer, 1000); // Setze das Interval neu
                }

                // Speicher die Daten nach jeder Aktualisierung
                localStorage.setItem('timerData', JSON.stringify(timerData));
            }

            // Starte die Timer-Updates
            updateTimer();
        }

        function resetTimer(id, button) {
            let timeLeft = 14400; // Reset auf 240 Minuten
            button.style.backgroundColor = "green"; // Timer bleibt grün
            button.innerHTML = "240:00"; // Zeige den Startwert an
            timerData[id] = { color: "green", timeLeft: timeLeft, lastUpdateTime: Date.now() };

            // Stoppe den Timer, falls er läuft
            if (timerIntervals[id]) {
                clearInterval(timerIntervals[id]);
            }

            // Speicher die Daten, wenn der Timer zurückgesetzt wird
            localStorage.setItem('timerData', JSON.stringify(timerData));

            // Starte den Timer neu
            startTimer(id, button);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${minutes}:${sec < 10 ? "0" + sec : sec}`;
        }

        window.onload = function() {
            const table = document.querySelector("table");

            for (let i = 0; i < 16; i++) {
                const row = document.createElement("tr");
                const headerCell = document.createElement("td");
                headerCell.className = "header";
                headerCell.textContent = `Timer ${i + 1}`;
                row.appendChild(headerCell);

                for (let j = 0; j < 16; j++) {
                    const buttonCell = document.createElement("td");
                    const button = document.createElement("button");
                    button.id = `btn${i * 16 + j}`;
                    button.textContent = "240:00"; // Anfangswert
                    button.onclick = function() {
                        toggleTimer(i * 16 + j); // Timer beim Klick neu starten oder zurücksetzen
                    };
                    buttonCell.appendChild(button);
                    row.appendChild(buttonCell);

                    // Wenn es gespeicherte Daten für diesen Timer gibt, stelle den Status wieder her
                    if (timerData[i * 16 + j]) {
                        button.style.backgroundColor = timerData[i * 16 + j].color;
                        button.innerHTML = formatTime(timerData[i * 16 + j].timeLeft);

                        // Berechne die verstrichene Zeit und adjustiere den Timer
                        const now = Date.now();
                        const timePassed = (now - timerData[i * 16 + j].lastUpdateTime) / 1000;
                        let newTimeLeft = timerData[i * 16 + j].timeLeft - timePassed;

                        // Wenn der Timer noch läuft, starte ihn weiter
                        if (newTimeLeft > 0 && timerData[i * 16 + j].color === "green") {
                            timerData[i * 16 + j].timeLeft = newTimeLeft;
                            startTimer(i * 16 + j, button);
                        } else {
                            // Wenn die Zeit abgelaufen ist, setze den Timer auf "yellow"
                            button.style.backgroundColor = "yellow";
                            button.innerHTML = "0:00";
                            timerData[i * 16 + j].color = "yellow";
                        }
                    }
                }

                table.appendChild(row);
            }
        };
    </script>

</body>
</html>
